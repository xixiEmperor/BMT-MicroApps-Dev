import{u as ce,r as I,d as $,o as Z,l as v,k as w,h as s,g as o,aT as de,x as i,M,w as p,j as C,aU as ue,p as pe,O as N,aV as q,aW as ve,A as h,ay as F,m as _e,af as me,as as he,ap as fe,P as G,Q as K,an as ke,E as l,a as ye,Z as X,J as _,aJ as we,c as Y}from"./index-GmfRbgMx.js";/* empty css                    *//* empty css                 */import{_ as ge}from"./_plugin-vue_export-helper-DedD7E0N.js";/* empty css                  */import{a as Ie,b as Ce,u as Te,l as xe,d as be,e as Pe,f as Ve,h as Se,i as ee}from"./forum-D70lqkAe.js";/* empty css                       *//* empty css                   */import{u as $e}from"./forum-C29PebQP.js";import"./format-BoKD-3ja.js";const Le={class:"post-detail-container"},Ue={key:0,class:"post-header"},Ee={class:"post-info"},Be={class:"author-info"},ze={class:"author-detail"},De={class:"author-name"},Re={class:"publish-time"},Me={class:"post-meta"},Ne={class:"view-count"},Fe={class:"delete-post"},Ae={key:1,class:"post-content"},He={class:"post-title"},Je=["innerHTML"],We={class:"post-action-bar"},je={class:"comment-section"},Oe={class:"comment-title"},Qe={class:"comment-form"},Ze={class:"comment-input-container"},qe={class:"comment-actions"},Ge={class:"word-count"},Ke={class:"comment-sort"},Xe={class:"comment-list"},Ye={class:"comment-user"},es={class:"comment-content"},ss={class:"comment-header"},ts={class:"comment-author"},os={class:"comment-time"},as={class:"comment-text"},ls={class:"comment-footer"},ns={class:"comment-actions"},is=["onClick"],rs=["onClick"],cs={class:"comment-delete-wrapper"},ds=["onClick"],us={key:0,class:"reply-form"},ps={class:"reply-input-container"},vs={class:"reply-actions"},_s={class:"reply-word-count"},ms={class:"reply-buttons"},hs={key:1,class:"reply-list"},fs={class:"reply-user"},ks={class:"reply-content"},ys={class:"reply-header"},ws={class:"reply-author"},gs={class:"reply-time"},Is={class:"reply-text"},Cs={key:0,class:"reply-to"},Ts={class:"reply-footer"},xs={class:"reply-actions"},bs=["onClick"],Ps=["onClick"],Vs={class:"reply-delete-wrapper"},Ss=["onClick"],$s={key:0,class:"reply-form nested-reply-form"},Ls={class:"reply-input-container"},Us={class:"reply-actions"},Es={class:"reply-word-count"},Bs={class:"reply-buttons"},zs=["onClick"],Ds={__name:"PostDetail",setup(Rs){const y=ke(),b=ye(),g=ce(),T=$e(),se=I();se.value=g.userInfo;const n=$(()=>T.currentPost||{}),L=async()=>{const t=y.params.id,e=await Ie(t);e.data.code===0?T.setCurrentPost(e.data.data):l.error(e.data.msg)};Z(()=>{L()});const U=$(()=>T.comments||[]),P=I("time_desc"),A=I("new"),V=async()=>{const t=y.params.id,e=await Ce(t,P.value);e.data.code===0&&T.setComments(e.data.data)};Z(()=>{V()});const x=I(""),H=$(()=>n.value&&n.value.replyCount!==void 0?n.value.replyCount:U.value?U.value.length:0),r=I({commentId:null,replyId:null,replyToUserId:null,content:"",placeholder:""}),E=I(!1),k=I({}),z=$(()=>U.value?U.value:[]),te=$(()=>E.value?z.value:z.value.slice(0,3)),J=async t=>{if(!g.token){l.warning("请先登录后再点赞"),b.push("/login");return}try{const e=y.params.id,d=t.id;if(t.isLiked){const u=await be(e,d);u.data.code===0?(t.likes-=1,t.isLiked=!1,l.success("已取消点赞")):l.error(u.data.msg||"操作失败")}else{const u=await Pe(e,d);u.data.code===0?(t.likes+=1,t.isLiked=!0,l.success("点赞成功")):l.error(u.data.msg||"操作失败")}}catch(e){console.error("点赞操作失败",e),l.error("操作失败，请稍后重试")}},oe=async()=>{if(x.value.trim()===""){l.warning("评论内容不能为空");return}if(!g.token){l.warning("请先登录后再评论"),b.push("/login");return}try{const t=y.params.id,e=await ee(t,{content:x.value,parentId:null});e.data.code===0?(await V(),await L(),x.value="",l.success("评论发表成功"),X().publish(`post_comment_to_${n.value.author}`,`${g.userinfo.username}评论了你的帖子`)):l.error(e.data.msg||"评论发表失败")}catch(t){console.error("评论发表失败",t),l.error("评论发表失败，请稍后重试")}},W=(t,e=null)=>{Y.confirm("确定要删除这条评论吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(async()=>{try{const d=y.params.id,u=t.id,m=await Ve(d,u);if(m.data.code===0){if(e){const f=e.children.findIndex(S=>S.id===t.id);f!==-1&&e.children.splice(f,1)}else await V();await L(),l.success("删除成功")}else l.error(m.data.msg||"删除失败")}catch(d){console.error("删除评论失败",d),l.error("删除失败，请稍后重试")}}).catch(()=>{})},j=(t,e=null)=>{if(!g.token){l.warning("请先登录后再回复"),b.push("/login");return}let d=`回复 ${t.nickname}：`,u=null,m=null,f=t.userId;e?(u=e.id,m=t.id,f=t.userId,d=`回复 @${t.nickname}：`,k.value={...k.value,[e.id]:!0}):(u=t.id,m=null,f=t.userId),r.value={commentId:u,replyId:m,replyToUserId:f,content:"",placeholder:d}},D=()=>{r.value={commentId:null,replyId:null,replyToUserId:null,content:"",placeholder:""}},O=async()=>{if(!r.value.content.trim()){l.warning("回复内容不能为空");return}try{const t=y.params.id,e={content:r.value.content,parentId:r.value.commentId};r.value.replyId&&(e.replyToId=r.value.replyId),r.value.replyToUserId&&(e.replyToUserId=r.value.replyToUserId);const d=await ee(t,e);d.data.code===0?(await V(),await L(),r.value.commentId&&(k.value={...k.value,[r.value.commentId]:!0}),D(),l.success("回复成功")):l.error(d.data.msg||"回复失败")}catch(t){console.error("提交回复失败",t),l.error("回复失败，请稍后重试")}},ae=()=>{E.value=!E.value},le=t=>{k.value={...k.value,[t]:!k.value[t]}},ne=t=>{t==="hot"?P.value="likes":t==="new"?P.value="time_desc":t==="old"?P.value="time_asc":P.value="time_desc",V()},Q=async()=>{if(!g.token){l.warning("请先登录后再点赞"),b.push("/login");return}try{const t=y.params.id;if(n.value.isLiked){const e=await Te(t);if(e.data.code===0){const d={...n.value,isLiked:!1,likes:n.value.likes-1};T.setCurrentPost(d),l.success("已取消点赞")}else l.error(e.data.msg||"操作失败")}else{const e=await xe(t);if(e.data.code===0){const d={...n.value,isLiked:!0,likes:n.value.likes+1};T.setCurrentPost(d),X().publish(`post_like_to_${n.value.author}`,`${g.userinfo.username}点赞了你的帖子`),l.success("点赞成功")}else l.error(e.data.msg||"操作失败")}}catch(t){console.error("点赞操作失败",t),l.error("操作失败，请稍后重试")}},ie=()=>{Y.confirm("确定要删除这篇帖子吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(async()=>{try{const t=y.params.id,e=await Se(t);e.data.code===0?(l.success("帖子删除成功"),b.push("/forum")):l.error(e.data.msg||"删除失败")}catch(t){console.error("删除帖子失败",t),l.error("删除失败，请稍后重试")}}).catch(()=>{})};return(t,e)=>{const d=de,u=pe,m=_e,f=me,S=he,re=fe,R=ve("auth");return _(),v("div",Le,[n.value?(_(),v("div",Ue,[s("div",Ee,[s("div",Be,[o(d,{size:40,src:n.value.authorAvatar,class:"author-avatar"},null,8,["src"]),s("div",ze,[s("div",De,i(n.value.author),1),s("div",Re,i(n.value.publishTime),1)])]),s("div",Me,[s("div",Ne,[o(u,null,{default:p(()=>[o(C(ue))]),_:1}),s("span",null,i(n.value.views)+" 次浏览",1)]),s("div",{class:N(["like-count",{"is-liked":n.value.isLiked}]),onClick:Q},[o(u,null,{default:p(()=>[o(C(q))]),_:1}),s("span",null,i(n.value.likes)+" 点赞",1)],2),M((_(),v("div",Fe,[o(m,{type:"danger",size:"small",onClick:ie},{default:p(()=>[o(u,null,{default:p(()=>[o(C(F))]),_:1}),e[4]||(e[4]=h(" 删除帖子 "))]),_:1})])),[[R,n.value.author]])])])])):w("",!0),n.value?(_(),v("div",Ae,[s("h1",He,i(n.value.title),1),s("div",{class:"content",innerHTML:n.value.content},null,8,Je),s("div",We,[o(m,{type:"primary",plain:!n.value.isLiked,onClick:Q,class:"like-button"},{default:p(()=>[o(u,null,{default:p(()=>[o(C(q))]),_:1}),h(" "+i(n.value.isLiked?"已点赞":"点赞")+" "+i(n.value.likes),1)]),_:1},8,["plain"])])])):w("",!0),s("div",je,[s("h3",Oe,"评论 "+i(H.value),1),s("div",Qe,[s("div",Ze,[o(f,{modelValue:x.value,"onUpdate:modelValue":e[0]||(e[0]=a=>x.value=a),type:"textarea",rows:"3",placeholder:"平等表达，友善交流",maxlength:"1000","show-word-limit":""},null,8,["modelValue"])]),s("div",qe,[s("span",Ge,i(x.value.length)+" / 1000",1),o(m,{type:"primary",onClick:oe},{default:p(()=>e[5]||(e[5]=[h("发送")])),_:1})])]),s("div",Ke,[o(re,{modelValue:A.value,"onUpdate:modelValue":e[1]||(e[1]=a=>A.value=a),onTabChange:ne},{default:p(()=>[o(S,{label:"最热",name:"hot"}),o(S,{label:"最新",name:"new"}),o(S,{label:"最早",name:"old"})]),_:1},8,["modelValue"])]),s("div",Xe,[(_(!0),v(G,null,K(te.value,a=>(_(),v("div",{key:a.id,class:"comment-item"},[s("div",Ye,[o(d,{size:36,src:a.avatar},{default:p(()=>[h(i(a.nickname[0]),1)]),_:2},1032,["src"])]),s("div",es,[s("div",ss,[s("span",ts,i(a.nickname),1),s("span",os,i(a.replyTime),1)]),s("div",as,i(a.content),1),s("div",ls,[s("div",ns,[s("span",{class:N(["comment-like",{"is-liked":a.isLiked}]),onClick:c=>J(a)},[o(u,null,{default:p(()=>[o(C(we))]),_:1}),h(" 点赞 "+i(a.likes),1)],10,is),s("span",{class:"comment-reply",onClick:c=>j(a)},"回复",8,rs)]),M((_(),v("div",cs,[s("span",{class:"comment-delete",onClick:c=>W(a)},[o(u,null,{default:p(()=>[o(C(F))]),_:1}),e[6]||(e[6]=h(" 删除 "))],8,ds)])),[[R,a.nickname]])]),r.value.commentId===a.id&&!r.value.replyId?(_(),v("div",us,[s("div",ps,[o(f,{modelValue:r.value.content,"onUpdate:modelValue":e[2]||(e[2]=c=>r.value.content=c),type:"textarea",rows:"2",placeholder:r.value.placeholder,maxlength:"500","show-word-limit":""},null,8,["modelValue","placeholder"])]),s("div",vs,[s("span",_s,i(r.value.content.length)+" / 500",1),s("div",ms,[o(m,{size:"small",onClick:D},{default:p(()=>e[7]||(e[7]=[h("取消")])),_:1}),o(m,{size:"small",type:"primary",onClick:O},{default:p(()=>e[8]||(e[8]=[h("回复")])),_:1})])])])):w("",!0),a.children&&a.children.length?(_(),v("div",hs,[(_(!0),v(G,null,K(k.value[a.id]?a.children:a.children.slice(0,3),c=>(_(),v("div",{key:c.id,class:"reply-item"},[s("div",fs,[o(d,{size:30,src:c.avatar},{default:p(()=>[h(i(c.nickname[0]),1)]),_:2},1032,["src"])]),s("div",ks,[s("div",ys,[s("span",ws,i(c.nickname),1),s("span",gs,i(c.replyTime),1)]),s("div",Is,[c.replyToNickname?(_(),v("span",Cs,"回复 @"+i(c.replyToNickname)+"：",1)):w("",!0),h(" "+i(c.content),1)]),s("div",Ts,[s("div",xs,[s("span",{class:N(["reply-like",{"is-liked":c.isLiked}]),onClick:B=>J(c)}," 点赞 "+i(c.likes),11,bs),s("span",{class:"reply-button",onClick:B=>j(c,a)},"回复",8,Ps)]),M((_(),v("div",Vs,[s("span",{class:"reply-delete",onClick:B=>W(c,a)},[o(u,null,{default:p(()=>[o(C(F))]),_:1}),e[9]||(e[9]=h(" 删除 "))],8,Ss)])),[[R,c.nickname]])]),r.value.commentId===a.id&&r.value.replyId===c.id?(_(),v("div",$s,[s("div",Ls,[o(f,{modelValue:r.value.content,"onUpdate:modelValue":e[3]||(e[3]=B=>r.value.content=B),type:"textarea",rows:"2",placeholder:r.value.placeholder,maxlength:"500","show-word-limit":"",autofocus:""},null,8,["modelValue","placeholder"])]),s("div",Us,[s("span",Es,i(r.value.content.length)+" / 500",1),s("div",Bs,[o(m,{size:"small",onClick:D},{default:p(()=>e[10]||(e[10]=[h("取消")])),_:1}),o(m,{size:"small",type:"primary",onClick:O},{default:p(()=>e[11]||(e[11]=[h("回复")])),_:1})])])])):w("",!0)])]))),128)),a.children.length>3?(_(),v("div",{key:0,class:"view-more-replies",onClick:c=>le(a.id)},i(k.value[a.id]?"收起回复":`查看全部 ${a.children.length} 条回复`),9,zs)):w("",!0)])):w("",!0)])]))),128)),z.value.length>3?(_(),v("div",{key:0,class:"view-more-comments",onClick:ae},i(E.value?"收起评论":`查看全部 ${H.value} 条评论`),1)):w("",!0)])])])}}},Zs=ge(Ds,[["__scopeId","data-v-48021ee2"]]);export{Zs as default};

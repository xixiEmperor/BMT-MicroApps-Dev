# =============================================================================
# BMTç¾½æ¯›çƒåœºé¦†ç®¡ç†ç³»ç»Ÿ Nginxé…ç½®æ–‡ä»¶ (è¯¦ç»†æ³¨é‡Šç‰ˆæœ¬)
# =============================================================================
# åŠŸèƒ½è¯´æ˜ï¼š
# 1. æ”¯æŒå‰åç«¯åˆ†ç¦»æ¶æ„ (Vue.js + React.js)
# 2. APIæ¥å£åå‘ä»£ç†å’Œè´Ÿè½½å‡è¡¡
# 3. WebSocketé•¿è¿æ¥æ”¯æŒ (å®æ—¶åŠŸèƒ½)
# 4. é™æ€èµ„æºä¼˜åŒ–å’Œç¼“å­˜ç­–ç•¥
# 5. å®‰å…¨é˜²æŠ¤å’Œé™æµä¿æŠ¤
# =============================================================================

# -----------------------------------------------------------------------------
# ä¸Šæ¸¸æœåŠ¡å™¨é…ç½® (Upstream Configuration)
# -----------------------------------------------------------------------------

# åç«¯APIæœåŠ¡å™¨é›†ç¾¤é…ç½®
# è¯´æ˜ï¼šå¤„ç†ä¸šåŠ¡é€»è¾‘ã€æ•°æ®åº“æ“ä½œã€ç”¨æˆ·è®¤è¯ç­‰
upstream backend_api {
    # åç«¯æœåŠ¡å™¨åœ°å€å’Œç«¯å£
    # weight=1: è´Ÿè½½å‡è¡¡æƒé‡
    # max_fails=3: æœ€å¤§å¤±è´¥æ¬¡æ•°ï¼Œè¶…è¿‡åæ ‡è®°ä¸ºä¸å¯ç”¨
    # fail_timeout=30s: å¤±è´¥è¶…æ—¶æ—¶é—´ï¼Œ30ç§’åé‡æ–°å°è¯•
    server bmt-backend:3000 weight=1 max_fails=3 fail_timeout=30s;
    
    # ä¿æŒé•¿è¿æ¥ï¼Œå‡å°‘è¿æ¥å¼€é”€
    # 32ä¸ªè¿æ¥æ± å¤§å°ï¼Œé€‚åˆä¸­ç­‰å¹¶å‘
    keepalive 32;
}

# WebSocketæœåŠ¡å™¨é›†ç¾¤é…ç½®
# è¯´æ˜ï¼šå¤„ç†å®æ—¶é€šä¿¡ã€æ¶ˆæ¯æ¨é€ã€åœ¨çº¿çŠ¶æ€ç­‰
upstream websocket_server {
    # WebSocketæœåŠ¡å™¨åœ°å€
    # æ³¨æ„ï¼šWebSocketéœ€è¦ç‰¹æ®Šçš„è¿æ¥å¤„ç†
    server bmt-websocket:5000 weight=1;
    
    # WebSocketè¿æ¥æ± 
    keepalive 32;
}

# -----------------------------------------------------------------------------
# ä¸»HTTPæœåŠ¡å™¨é…ç½® (Main Server Block)
# -----------------------------------------------------------------------------
server {
    # ç›‘å¬ç«¯å£é…ç½®
    listen 80;  # HTTPç«¯å£
    
    # æœåŠ¡å™¨åŸŸåé…ç½®
    # è¯·å°† your-domain.com æ›¿æ¢ä¸ºæ‚¨çš„å®é™…åŸŸå
    # æ”¯æŒå¤šä¸ªåŸŸåï¼šserver_name domain1.com domain2.com;
    server_name localhost your-domain.com;
    
    # ç½‘ç«™æ ¹ç›®å½•é…ç½®
    # Dockerå®¹å™¨å†…çš„é™æ€æ–‡ä»¶è·¯å¾„
    root /usr/share/nginx/html;
    
    # é»˜è®¤é¦–é¡µæ–‡ä»¶
    # æŒ‰é¡ºåºæŸ¥æ‰¾ï¼šindex.html -> index.htm
    index index.html index.htm;
    
    # =================================================================
    # å®‰å…¨å“åº”å¤´é…ç½® (Security Headers)
    # =================================================================
    
    # é˜²æ­¢é¡µé¢è¢«åµŒå…¥iframeï¼Œé˜²æ­¢ç‚¹å‡»åŠ«æŒæ”»å‡»
    add_header X-Frame-Options "SAMEORIGIN" always;
    
    # é˜²æ­¢MIMEç±»å‹å—…æ¢ï¼Œé˜²æ­¢XSSæ”»å‡»
    add_header X-Content-Type-Options "nosniff" always;
    
    # å¯ç”¨XSSè¿‡æ»¤å™¨ï¼Œé˜²æ­¢è·¨ç«™è„šæœ¬æ”»å‡»
    add_header X-XSS-Protection "1; mode=block" always;
    
    # =================================================================
    # é™æ€èµ„æºç¼“å­˜é…ç½® (Static Assets Caching)
    # =================================================================
    # åŒ¹é…å¸¸è§çš„é™æ€èµ„æºæ–‡ä»¶æ‰©å±•å
    location ~* \.(css|js|jpg|jpeg|png|gif|ico|svg|woff|woff2|ttf|eot)$ {
        # ç¼“å­˜1å¹´ï¼Œé€‚åˆå¸¦ç‰ˆæœ¬å·çš„é™æ€èµ„æº
        expires 1y;
        
        # è®¾ç½®ç¼“å­˜æ§åˆ¶å¤´
        # public: å…è®¸CDNå’Œæµè§ˆå™¨ç¼“å­˜
        # immutable: å‘Šè¯‰æµè§ˆå™¨èµ„æºä¸ä¼šæ”¹å˜
        add_header Cache-Control "public, immutable";
        
        # æ ¹æ®Accept-Encodingå¤´è¿”å›ä¸åŒç‰ˆæœ¬ï¼ˆgzipå‹ç¼©ï¼‰
        add_header Vary "Accept-Encoding";
        
        # å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œè¿”å›404è€Œä¸æ˜¯fallbackåˆ°index.html
        try_files $uri =404;
    }
    
    # =================================================================
    # APIæ¥å£åå‘ä»£ç†é…ç½® (API Reverse Proxy)
    # =================================================================
    # å¤„ç†æ‰€æœ‰ /api/ å¼€å¤´çš„è¯·æ±‚ï¼Œè½¬å‘åˆ°åç«¯æœåŠ¡
    location /api/ {
        # é™æµä¿æŠ¤ï¼šé˜²æ­¢APIè¢«æ¶æ„è¯·æ±‚
        # zone=api: ä½¿ç”¨apié™æµåŒºåŸŸ
        # burst=20: å…è®¸çªå‘20ä¸ªè¯·æ±‚
        # nodelay: ä¸å»¶è¿Ÿå¤„ç†çªå‘è¯·æ±‚
        limit_req zone=api burst=20 nodelay;
        
        # è½¬å‘åˆ°åç«¯APIæœåŠ¡å™¨é›†ç¾¤
        proxy_pass http://backend_api;
        
        # ä½¿ç”¨HTTP/1.1åè®®ï¼Œæ”¯æŒé•¿è¿æ¥
        proxy_http_version 1.1;
        
        # WebSocketå‡çº§æ”¯æŒï¼ˆAPIä¸­å¯èƒ½æœ‰WebSocketç«¯ç‚¹ï¼‰
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        
        # ä¼ é€’åŸå§‹è¯·æ±‚ä¿¡æ¯ç»™åç«¯
        proxy_set_header Host $host;                    # åŸå§‹Hostå¤´
        proxy_set_header X-Real-IP $remote_addr;        # å®¢æˆ·ç«¯çœŸå®IP
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;  # ä»£ç†é“¾IP
        proxy_set_header X-Forwarded-Proto $scheme;     # åŸå§‹åè®®(http/https)
        
        # è¶…æ—¶é…ç½®ï¼šé˜²æ­¢é•¿æ—¶é—´ç­‰å¾…
        proxy_connect_timeout 30s;  # è¿æ¥åç«¯è¶…æ—¶
        proxy_send_timeout 30s;     # å‘é€æ•°æ®è¶…æ—¶
        proxy_read_timeout 30s;     # è¯»å–å“åº”è¶…æ—¶
        
        # ç¦ç”¨å‡çº§è¯·æ±‚çš„ç¼“å­˜
        proxy_cache_bypass $http_upgrade;
        
        # æ”¯æŒå¤§æ–‡ä»¶ä¸Šä¼ ï¼ˆå¦‚å¤´åƒã€åœºåœ°å›¾ç‰‡ç­‰ï¼‰
        client_max_body_size 100M;
    }
    
    # =================================================================
    # WebSocketä»£ç†é…ç½® (WebSocket Proxy) - æ ¸å¿ƒå®æ—¶åŠŸèƒ½ï¼
    # =================================================================
    # å¤„ç†æ‚¨çš„ useRealtime.ts ä¸­çš„WebSocketè¿æ¥
    location /ws/ {
        # è½¬å‘åˆ°WebSocketæœåŠ¡å™¨
        proxy_pass http://websocket_server;
        
        # å¿…é¡»ä½¿ç”¨HTTP/1.1åè®®è¿›è¡ŒWebSocketæ¡æ‰‹
        proxy_http_version 1.1;
        
        # WebSocketåè®®å‡çº§çš„å¿…éœ€å¤´éƒ¨
        proxy_set_header Upgrade $http_upgrade;        # åè®®å‡çº§è¯·æ±‚
        proxy_set_header Connection "upgrade";         # è¿æ¥å‡çº§
        
        # ä¼ é€’å®¢æˆ·ç«¯ä¿¡æ¯
        proxy_set_header Host $host;                   # ä¿æŒåŸå§‹Host
        proxy_set_header X-Real-IP $remote_addr;       # å®¢æˆ·ç«¯çœŸå®IP
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;  # ä»£ç†é“¾
        proxy_set_header X-Forwarded-Proto $scheme;    # åŸå§‹åè®®
        
        # WebSocketé•¿è¿æ¥ç‰¹æ®Šè¶…æ—¶é…ç½®
        # 7å¤©è¶…æ—¶ï¼Œæ”¯æŒé•¿æ—¶é—´è¿æ¥ï¼ˆå¦‚å®æ—¶ç›‘æ§ã€åœ¨çº¿çŠ¶æ€ï¼‰
        proxy_connect_timeout 7d;   # å»ºç«‹è¿æ¥è¶…æ—¶
        proxy_send_timeout 7d;      # å‘é€æ¶ˆæ¯è¶…æ—¶
        proxy_read_timeout 7d;      # è¯»å–æ¶ˆæ¯è¶…æ—¶
        
        # ç¦ç”¨ä»£ç†ç¼“å†²ï¼Œç¡®ä¿æ¶ˆæ¯å®æ—¶ä¼ è¾“
        proxy_buffering off;        # ä¸ç¼“å†²å“åº”
        proxy_cache off;            # ä¸ç¼“å­˜å“åº”
    }
    
    # =================================================================
    # Socket.IOæ”¯æŒé…ç½® (Socket.IO Support)
    # =================================================================
    # å¦‚æœæ‚¨çš„é¡¹ç›®ä½¿ç”¨Socket.IOè€Œä¸æ˜¯åŸç”ŸWebSocket
    location /socket.io/ {
        # è½¬å‘åˆ°WebSocketæœåŠ¡å™¨
        proxy_pass http://websocket_server;
        
        # Socket.IOéœ€è¦HTTP/1.1åè®®
        proxy_http_version 1.1;
        
        # Socket.IOåè®®å‡çº§å¤´éƒ¨
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Socket.IOé•¿è¿æ¥é…ç½®
        # æ”¯æŒè½®è¯¢fallbackå’ŒWebSocketå‡çº§
        proxy_connect_timeout 7d;
        proxy_send_timeout 7d; 
        proxy_read_timeout 7d;
        
        # ç¦ç”¨ç¼“å†²ä»¥æ”¯æŒå®æ—¶é€šä¿¡
        proxy_buffering off;
    }
    
    # =================================================================
    # å‰ç«¯åº”ç”¨è·¯ç”±é…ç½® (Frontend Routing)
    # =================================================================
    
    # Bç«¯ç®¡ç†åå°è·¯ç”± (React SPA)
    # å¤„ç† /admin/ å¼€å¤´çš„æ‰€æœ‰è·¯ç”±
    location /admin/ {
        # SPAè·¯ç”±å¤„ç†ï¼š
        # 1. å…ˆå°è¯•æ‰¾åˆ°å®é™…æ–‡ä»¶ ($uri)
        # 2. å†å°è¯•æ‰¾åˆ°ç›®å½• ($uri/)
        # 3. æœ€åfallbackåˆ°ç®¡ç†åå°å…¥å£æ–‡ä»¶
        try_files $uri $uri/ /admin/index.html;
    }
    
    # Cç«¯ç”¨æˆ·åº”ç”¨è·¯ç”± (Vue.js SPA)
    # å¤„ç†æ‰€æœ‰å…¶ä»–è·¯ç”±ï¼ˆä¼˜å…ˆçº§æœ€ä½ï¼‰
    location / {
        # Vue Routerçš„historyæ¨¡å¼æ”¯æŒ
        # æ‰€æœ‰æœªåŒ¹é…çš„è·¯ç”±éƒ½è¿”å›ä¸»åº”ç”¨å…¥å£
        try_files $uri $uri/ /index.html;
    }
    
    # =================================================================
    # ç³»ç»ŸåŠŸèƒ½é…ç½® (System Functions)
    # =================================================================
    
    # å¥åº·æ£€æŸ¥ç«¯ç‚¹
    # ç”¨äºè´Ÿè½½å‡è¡¡å™¨å’Œç›‘æ§ç³»ç»Ÿæ£€æŸ¥æœåŠ¡çŠ¶æ€
    location /health {
        # ä¸è®°å½•å¥åº·æ£€æŸ¥æ—¥å¿—ï¼Œå‡å°‘æ—¥å¿—å™ªéŸ³
        access_log off;
        
        # ç›´æ¥è¿”å›200çŠ¶æ€ç å’Œå¥åº·ä¿¡æ¯
        return 200 "healthy\n";
        
        # è®¾ç½®å“åº”å†…å®¹ç±»å‹
        add_header Content-Type text/plain;
    }
    
    # =================================================================
    # å®‰å…¨é…ç½® (Security Configuration)
    # =================================================================
    
    # éšè—æ‰€æœ‰ç‚¹æ–‡ä»¶ï¼ˆ.htaccess, .env, .gitç­‰ï¼‰
    location ~ /\. {
        deny all;  # æ‹’ç»æ‰€æœ‰è®¿é—®
    }
    
    # éšè—æ•æ„Ÿé…ç½®æ–‡ä»¶
    location ~* \.(env|log|ini)$ {
        deny all;  # é˜²æ­¢é…ç½®æ–‡ä»¶æ³„éœ²
    }
    
    # =================================================================
    # æ–‡ä»¶ä¸Šä¼ è®¿é—®é…ç½® (File Upload Access)
    # =================================================================
    
    # ç”¨æˆ·ä¸Šä¼ æ–‡ä»¶è®¿é—®ï¼ˆå¤´åƒã€åœºåœ°å›¾ç‰‡ç­‰ï¼‰
    location /uploads/ {
        # æ˜ å°„åˆ°å®¹å™¨å†…çš„ä¸Šä¼ ç›®å½•
        alias /app/uploads/;
        
        # é•¿æœŸç¼“å­˜ä¸Šä¼ çš„æ–‡ä»¶
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
}

# =============================================================================
# HTTPSé…ç½® (ç”Ÿäº§ç¯å¢ƒ) - å–æ¶ˆæ³¨é‡Šä»¥å¯ç”¨
# =============================================================================
# ç”Ÿäº§ç¯å¢ƒHTTPSé…ç½®ç¤ºä¾‹
# ä½¿ç”¨å‰è¯·ï¼š
# 1. è·å–SSLè¯ä¹¦ï¼ˆLet's Encryptæ¨èï¼‰
# 2. å°†è¯ä¹¦æ–‡ä»¶æ”¾åˆ° nginx/ssl/ ç›®å½•
# 3. ä¿®æ”¹åŸŸåä¸ºæ‚¨çš„å®é™…åŸŸå
# 4. å–æ¶ˆä¸‹é¢çš„æ³¨é‡Š

# server {
#     # ç›‘å¬HTTPSç«¯å£ï¼Œå¯ç”¨HTTP/2
#     listen 443 ssl http2;
#     server_name your-domain.com;  # æ›¿æ¢ä¸ºå®é™…åŸŸå
#     
#     # SSLè¯ä¹¦é…ç½®
#     ssl_certificate /etc/nginx/ssl/your-domain.crt;      # è¯ä¹¦æ–‡ä»¶
#     ssl_certificate_key /etc/nginx/ssl/your-domain.key;  # ç§é’¥æ–‡ä»¶
#     
#     # SSLå®‰å…¨é…ç½®
#     ssl_protocols TLSv1.2 TLSv1.3;  # åªæ”¯æŒå®‰å…¨çš„TLSç‰ˆæœ¬
#     ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384;
#     ssl_prefer_server_ciphers off;   # è®©å®¢æˆ·ç«¯é€‰æ‹©æœ€ä½³åŠ å¯†å¥—ä»¶
#     
#     # SSLä¼šè¯ç¼“å­˜ï¼Œæé«˜æ€§èƒ½
#     ssl_session_cache shared:SSL:10m;  # 10MBå…±äº«ç¼“å­˜
#     ssl_session_timeout 10m;           # ä¼šè¯è¶…æ—¶æ—¶é—´
#     
#     # å¼ºåˆ¶HTTPSï¼ˆå¯é€‰ï¼‰
#     # add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
#     
#     # å…¶ä»–é…ç½®ä¸HTTP serverå—ç›¸åŒ...
#     # å¤åˆ¶ä¸Šé¢HTTPé…ç½®ä¸­çš„locationå—åˆ°è¿™é‡Œ
# }

# HTTPåˆ°HTTPSé‡å®šå‘ï¼ˆå¯é€‰ï¼‰
# server {
#     listen 80;
#     server_name your-domain.com;
#     return 301 https://$server_name$request_uri;
# }

# =============================================================================
# é…ç½®æ–‡ä»¶è¯´æ˜æ€»ç»“
# =============================================================================
# 
# æœ¬é…ç½®æ–‡ä»¶å®ç°äº†ä»¥ä¸‹åŠŸèƒ½ï¼š
# 
# ğŸŒ å‰ç«¯åº”ç”¨æ”¯æŒï¼š
#    - Vue.js Cç«¯åº”ç”¨ (æ ¹è·¯å¾„ /)
#    - React.js Bç«¯ç®¡ç†åå° (/admin/)
#    - SPAè·¯ç”±æ”¯æŒ (History API)
# 
# ğŸ”„ åç«¯æœåŠ¡ä»£ç†ï¼š
#    - REST APIæ¥å£ä»£ç† (/api/)
#    - è´Ÿè½½å‡è¡¡å’Œæ•…éšœè½¬ç§»
#    - è¯·æ±‚é™æµå’Œå®‰å…¨é˜²æŠ¤
# 
# âš¡ å®æ—¶é€šä¿¡æ”¯æŒï¼š
#    - WebSocketé•¿è¿æ¥ (/ws/)
#    - Socket.IOæ”¯æŒ (/socket.io/)
#    - å®æ—¶æ¶ˆæ¯æ¨é€
# 
# ğŸš€ æ€§èƒ½ä¼˜åŒ–ï¼š
#    - é™æ€èµ„æºç¼“å­˜
#    - Gzipå‹ç¼©
#    - HTTP/2æ”¯æŒ
#    - è¿æ¥å¤ç”¨
# 
# ğŸ”’ å®‰å…¨é˜²æŠ¤ï¼š
#    - å®‰å…¨å“åº”å¤´
#    - æ•æ„Ÿæ–‡ä»¶éšè—
#    - è¯·æ±‚é™æµ
#    - XSSé˜²æŠ¤
# 
# ğŸ“ æ–‡ä»¶æœåŠ¡ï¼š
#    - ç”¨æˆ·ä¸Šä¼ æ–‡ä»¶è®¿é—®
#    - é™æ€èµ„æºæœåŠ¡
#    - ç¼“å­˜ä¼˜åŒ–
# 
# ğŸ¥ å¥åº·ç›‘æ§ï¼š
#    - å¥åº·æ£€æŸ¥ç«¯ç‚¹
#    - æœåŠ¡çŠ¶æ€ç›‘æ§
#    - è´Ÿè½½å‡è¡¡å™¨é›†æˆ
# 
# =============================================================================
